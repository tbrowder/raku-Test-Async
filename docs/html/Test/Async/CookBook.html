<!DOCTYPE html>
<html lang="en">
<head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <title>Test::Async::CookBook</title>
    <meta charset="UTF-8">
    <style>hr,
img {
    box-sizing: content-box
}
body::after,
body::before,
hr::after,
hr::before {
    display: table;
    content: ""
}
a,
a:not([href]) {
    text-decoration: none
}

hr,
svg:not(:root) {
    overflow: hidden
}

img,
table tr {
    background-color: #fff
}

pre,
table {
    overflow: auto
}

dl,
dl dt,
hr,
pre code,
pre>code,
td,
th {
    padding: 0
}

input,
pre code {
    overflow: visible
}

pre,
pre code {
    word-wrap: normal
}

body {
    -ms-text-size-adjust: 100%;
    -webkit-text-size-adjust: 100%;
    color: #333;
    font-family: "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
    font-size: 16px;
    line-height: 1.5;
    word-wrap: break-word;
    width: 820px;
    margin: 2em auto;
}

a {
    background-color: transparent;
    -webkit-text-decoration-skip: objects;
    color: #4078c0
}

a:active,
a:hover {
    outline-width: 0;
    text-decoration: underline
}

h1 {
    margin: .67em 0
}

img {
    border-style: none;
    max-width: 100%
}

h1,
h2 {
    padding-bottom: .3em;
    border-bottom: 1px solid #eee
}

input {
    font: inherit;
    margin: 0;
    font-family: inherit;
    font-size: inherit;
    line-height: inherit
}

* {
    box-sizing: border-box
}

strong {
    font-weight: 600
}

body::after,
hr::after {
    clear: both
}

table {
    border-spacing: 0;
    border-collapse: collapse;
    display: block;
    width: 100%
}

blockquote {
    margin: 0;
    padding: 0 1em;
    color: #777;
    border-left: .25em solid #ddd
}

ol ol,
ul ol {
    list-style-type: lower-roman
}

ol ol ol,
ol ul ol,
ul ol ol,
ul ul ol {
    list-style-type: lower-alpha
}

dd {
    margin-left: 0
}

code {
    font-family: Consolas, "Liberation Mono", Menlo, Courier, monospace
}

pre {
    font: 12px Consolas, "Liberation Mono", Menlo, Courier, monospace
}

input {
    -webkit-font-feature-settings: "liga" 0;
    font-feature-settings: "liga" 0
}

body>:first-child {
    margin-top: 0!important
}

body>:last-child {
    margin-bottom: 0!important
}

a:not([href]) {
    color: inherit
}

blockquote,
dl,
ol,
p,
pre,
table,
ul {
    margin-top: 0;
    margin-bottom: 16px
}

hr {
    background: #e7e7e7;
    height: .25em;
    margin: 24px 0;
    border: 0
}

blockquote>:first-child {
    margin-top: 0
}

blockquote>:last-child {
    margin-bottom: 0
}

h1,
h2,
h3,
h4,
h5,
h6 {
    margin-top: 24px;
    margin-bottom: 16px;
    font-weight: 600;
    line-height: 1.25
}

dl dt,
table th {
    font-weight: 700
}

h1 code,
h1 tt,
h2 code,
h2 tt,
h3 code,
h3 tt,
h4 code,
h4 tt,
h5 code,
h5 tt,
h6 code,
h6 tt {
    font-size: inherit
}

h1 {
    font-size: 2em
}

h2 {
    font-size: 1.5em
}

h3 {
    font-size: 1.25em
}

h4 {
    font-size: 1em
}

h5 {
    font-size: .875em
}

h6 {
    font-size: .85em;
    color: #777
}

ol,
ul {
    padding-left: 2em
}

ol ol,
ol ul,
ul ol,
ul ul {
    margin-top: 0;
    margin-bottom: 0
}

li>p {
    margin-top: 16px
}

li+li {
    margin-top: .25em
}

dl dt {
    margin-top: 16px;
    font-size: 1em;
    font-style: italic
}

dl dd {
    padding: 0 16px;
    margin-bottom: 16px
}

table td,
table th {
    padding: 6px 13px;
    border: 1px solid #ddd
}

table tr {
    border-top: 1px solid #ccc
}

table tr:nth-child(2n) {
    background-color: #f8f8f8
}

code {
    padding: .2em 0;
    margin: 0;
    font-size: 85%;
    background-color: rgba(0, 0, 0, .04);
    border-radius: 3px
}

code::after,
code::before {
    letter-spacing: -.2em;
    content: "\00a0"
}

pre>code {
    margin: 0;
    font-size: 100%;
    word-break: normal;
    white-space: pre;
    background: 0 0;
    border: 0
}

pre {
    padding: 16px;
    font-size: 85%;
    line-height: 1.45;
    background-color: #f7f7f7;
    border-radius: 3px
}

pre code {
    display: inline;
    max-width: auto;
    margin: 0;
    line-height: inherit;
    background-color: transparent;
    border: 0
}

pre code::after,
pre code::before {
    content: normal
}

kbd {
    display: inline-block;
    padding: 3px 5px;
    font: 11px Consolas, "Liberation Mono", Menlo, Courier, monospace;
    line-height: 10px;
    color: #555;
    vertical-align: middle;
    background-color: #fcfcfc;
    border: 1px solid #ccc;
    border-bottom-color: #bbb;
    border-radius: 3px;
    box-shadow: inset 0 -1px 0 #bbb
}

hr {
    border-bottom-color: #eee
}
</style>

    
<style class="build-tools-gen-doc">.toc-level-1 .toc-text { padding-left: 1.5em; }
.toc-level-2 .toc-text { padding-left: 2.5em; }
.toc-level-3 .toc-text { padding-left: 3.5em; }
.toc-level-4 .toc-text { padding-left: 4.5em; }
.toc-level-5 .toc-text { padding-left: 5.5em; }
#TOC * { border-width: 0; }
li > p { margin: inherit; }
li > .pod-block-code { margin-top: 16px; }
</style></head>

<body class="pod">
    <div id="___top"></div>
    <nav class="indexgroup">
<table id="TOC">
<caption><h2 id="TOC_Title">Table of Contents</h2></caption>
<tr class="toc-level-1"><td class="toc-number">1</td><td class="toc-text"><a href="#Test::Async_COOK_BOOK"><code class="pod-code-inline">Test::Async</code> COOK BOOK</a></td></tr>
<tr class="toc-level-2"><td class="toc-number">1.1</td><td class="toc-text"><a href="#Don't_Use_Test::Async_In_A_Module">Don't Use <code class="pod-code-inline">Test::Async</code> In A Module</a></td></tr>
<tr class="toc-level-2"><td class="toc-number">1.2</td><td class="toc-text"><a href="#Testing_A_Multithreaded_Application">Testing A Multithreaded Application</a></td></tr>
<tr class="toc-level-2"><td class="toc-number">1.3</td><td class="toc-text"><a href="#Export_From_A_Bundle">Export From A Bundle</a></td></tr>
<tr class="toc-level-1"><td class="toc-number">2</td><td class="toc-text"><a href="#SEE_ALSO">SEE ALSO</a></td></tr>
<tr class="toc-level-1"><td class="toc-number">3</td><td class="toc-text"><a href="#COPYRIGHT">COPYRIGHT</a></td></tr>
<tr class="toc-level-1"><td class="toc-number">4</td><td class="toc-text"><a href="#LICENSE">LICENSE</a></td></tr>

</table>
</nav>


    <div class="pod-body">
    <h1 id="Test::Async_COOK_BOOK"><a class="u" href="#___top" title="go to top of document"><code>Test::Async</code> COOK BOOK</a></h1>
<p>Non-systematic collection of tips.</p>
<h2 id="Don't_Use_Test::Async_In_A_Module"><a class="u" href="#___top" title="go to top of document">Don't Use <code>Test::Async</code> In A Module</a></h2>
<p>... unless you really know what you're doing.</p>
<p><strong>Note</strong> that this section is not about creating own test bundle.</p>
<p><a href="../Async.html"><code>Test::Async</code></a> itself does some backstage work when imported with <code>use</code> or <code>require</code>. A part of this work is taking a list of registered bundles, fixing it, and building a <a href="https://docs.raku.org/type/Map"><code>Map</code></a> of exports out of it. The potential problem hides behind the word <em>fixing</em> because what it means is adding <a href="Base.html"><code>Test::Async::Base</code></a> into the list of registered bundles if no other bundles is registered yet; and adding <a href="Reporter/TAP.html"><code>Test::Async::Reporter::TAP</code></a> to the list if none of the registered bundles does <a href="Reporter.html"><code>Test::Async::Reporter</code></a> role. Say, if there is a module <code>Foo</code> which <code>use</code>s <code>Test::Async</code>, and there is a suite with a header like this:</p>
<pre class="pod-block-code">use Foo;
use MyTests;
use MyReporter;
use Test::Async;
</pre>
<p>Then we will have implicitly registered <code>Test::Async::Base</code> and <code>Test::Async::Reporter::TAP</code>. While not being a problem most of the time, this could pose a risk in some unforeseen edge cases.</p>
<p>The recommended way is to use <code>Test::Async::Hub</code> class <code>test-suite</code> method which returns the current test :</p>
<pre class="pod-block-code">use Test::Async::Hub;
sub foo {
    my $suite = Test::Async::Hub.test-suite;
    $suite.pass("that's the way")
}
</pre>
<p>Another recommended way is shown in the first example of the next section.</p>
<h2 id="Testing_A_Multithreaded_Application"><a class="u" href="#___top" title="go to top of document">Testing A Multithreaded Application</a></h2>
<p>One of the biggest reasons which pushed me to implement <code>Test::Async</code> was a need to test event flow in <code>Vikna</code> toolkit. The problem with the standard <code>Test</code> framework was the need to invoke test tool from inside a separate thread or even threads causing havoc to the test output when <code>subtest</code>s are used. Similar problem could arise for any heavily threaded application where it is not always easy to get hold of the internal states without having direct access to them from within of a thread. Sure, it is technically possible to implement a communication channel which could be used to pass data into the test suit main thread, etc., etc., etc.</p>
<p>Nah, that's not how we do it! How about:</p>
<pre class="pod-block-code">subtest "Threaded testing" =&gt; {
    my $test-app = MyTestApp.new( :test-suite(test-suite) );
    $test-app.test-something-threaded;
}
</pre>
<p>and then somewhere in the <code>MyTestApp</code> class implementation, which is presumably inherits from the base application class and overrides some of its method for testing, we simply do something like:</p>
<pre class="pod-block-code">method foo ($param) {
    self.test-suite.item.ok(self.is-param-valid($param), "method foo got correct parameter");
    nextsame
}
</pre>
<p><code>test-suite</code> attribute in this example is the suite object backing our subtest.</p>
<p>It is also possible not to store the suite object as an attribute. Instead, one could use <a href="JobMgr.html"><code>Test::Async::JobMgr</code></a> method <code>start</code> to spawn new threads. This approach has two advantages: first, it preserves the suite object, on which the method has been invoked, as the one available via <code>test-suite</code>; second, it creates an awaitable job meaning that our subtest won't finish until the job is complete:</p>
<pre class="pod-block-code">method test-something-threaded {
    for ^10 -&gt; $i {
        Test::Async::Hub.test-suite.start({
            self.bar($i)
        })
    }
}
method bar ($i) {
    Test::Async::Hub.test-suite.cmp-ok($i, "&lt;", 10, "small enough")
}
</pre>
<p>All outcomes of <code>cmp-ok</code> will be reported as part of our <code>subtest</code>.</p>
<p>This approach provides more flexibility because it makes it possible to simultaneously test different execution branches of the same object:</p>
<pre class="pod-block-code">use Test::Async;
plan 1, :parallel;
my $test-app = MyTestApp.new;
subtest "Branch 1" =&gt; {
    $test-app.test-something-threaded1;
}
subtest "Branch 2" =&gt; {
    $test-app.test-something-threaded2;
}
</pre>
<p>When both methods <code>test-something-threaded&lt;N&gt;</code> are using <code>test-suite.start</code> then both subtests will report only related test tool outcomes.</p>
<h2 id="Export_From_A_Bundle"><a class="u" href="#___top" title="go to top of document">Export From A Bundle</a></h2>
<p>Sometimes it might be useful to export a symbol or two from a bundle. The best way to do it is to use <code>EXPORT::DEFAULT</code> package defined in your bundle file:</p>
<pre class="pod-block-code">test-bundle Test::Async::MyBundle {
    ...
}
package EXPORT::DEFAULT {
    our sub foo { "exported" }
}
</pre>
<p>The reason for doing so is because a user could consume the bundle using <a href="../Async.html"><code>Test::Async</code></a> parameters:</p>
<pre class="pod-block-code">use Test::Async &lt;MyBundle Base&gt;;
say foo;
</pre>
<p>In this case <a href="../Async.html"><code>Test::Async</code></a> not only will export all found test tool methods but it would also fetch the symbols from <code>EXPORT::DEFAULT</code> and re-export them. Apparently, the approach allows direct consuming via <code>use</code> statement to work too:</p>
<pre class="pod-block-code">use Test::Async::MyBundle;
use Test::Async::Base;
use Test::Async;
say foo;
</pre>
<h1 id="SEE_ALSO"><a class="u" href="#___top" title="go to top of document">SEE ALSO</a></h1>
<ul><li><p><a href="../Async.html"><code>Test::Async</code></a></p>
</li>
<li><p><a href="Manual.html"><code>Test::Async::Manual</code></a></p>
</li>
<li><p><a href="../../../../INDEX.html"><code>INDEX</code></a></p>
</li>
</ul>
<h1 id="COPYRIGHT"><a class="u" href="#___top" title="go to top of document">COPYRIGHT</a></h1>
<p>(c) 2020-2023, Vadim Belman &lt;vrurg@cpan.org&gt;</p>
<h1 id="LICENSE"><a class="u" href="#___top" title="go to top of document">LICENSE</a></h1>
<p>Artistic License 2.0</p>
<p>See the <a href="../../../../LICENSE"><em>LICENSE</em></a> file in this distribution.</p>

    </div>

    
</body>
</html>
